!SLIDE smbullets small
# Hooks

* Foreman plugin Webhooks allows to call webhooks
* Smart Proxy plugin Shellhooks provides webhook to execute scripts
* Add both to trigger actions on events in Foreman
 * Call webhooks or run additional scripts on events
 * Log execution
 * Do not block Foreman

* _Use case:_ 
 * Extend the Foreman without writing a plugin
 * Work around the limitations and problems of existing tools

~~~SECTION:notes~~~


~~~ENDSECTION~~~

~~~SECTION:handouts~~~

****

~~~PAGEBREAK~~~

The Foreman plugin Webhooks allows to add scripts on events handled by the Foreman. Typically it is used
to integrate other tools during the orchestration process of deploying new hosts instead of writing
a new plugin. This can be done by calling a webhook or by utilizing the Smart Proxy plugin Shellhook to
execute a script.

Another use case is to work around the limitations and problems of tools like changing parameters of
VMs which is only available after the creation but are required before starting them.

This plugin is a new solution replacing another one called Hooks, with some other design decisions
like having it not blocking and rolling back the action in Foreman.

More details on: https://docs.theforeman.org/3.9/Administering_Project/index-katello.html#Using_Webhooks_admin

~~~ENDSECTION~~~

!SLIDE smbullets small
# Lab ~~~SECTION:MAJOR~~~.~~~SECTION:MINOR~~~: Hooks

* Objective:
 * Execute a shell script printing arguments when entering build mode
* Steps:
 * Install the Foreman plugin Webhooks and Smart Proxy plugin Shellhooks
 * Configure a Webhook to trigger the Shellhook print_args
 * Increase the log level of Smart Proxy to DEBUG
 * Activate build mode of a Host and inspect the Smart Proxy's log

!SLIDE supplemental exercises
# Lab ~~~SECTION:MAJOR~~~.~~~SECTION:MINOR~~~: Hooks

## Objective:

****

* Execute a shell script printing arguments when entering build mode

## Steps:

****

* Install the Foreman plugin Webhooks and Smart Proxy plugin Shellhooks using the foreman-installer
* Configure a Webhook to trigger the Shellhook print_args

Configuration is done at "Administer > Webhook > Webhooks".
You can find the URL of your Smart Proxy using the WebUI at "Infrastructure > Smart Proxies", selecting the Smart Proxy on the tab "Overview".
The Shellhooks plugin can accessed at `/shellhook/` followed by the hook and requires Proxy Authorization.
The Shellhook print_args uses an empty payload and prints arguments via HTTP headers in the format "X-Shellhook-Arg-1".

* Increase the log level of Smart Proxy to DEBUG

This can be done in /etc/foreman-proxy/settings.yml and requires a restart of the service.

* Activate build mode of a Host and inspect the Smart Proxy's log

#### Expected result:

You will see the execution of and output generated by the shellhook in the log.

!SLIDE supplemental solutions
# Lab ~~~SECTION:MAJOR~~~.~~~SECTION:MINOR~~~: Hooks

****

## Execute a shell script printing arguments when entering build mode

****

### Install the Foreman plugin Webhooks and Smart Proxy plugin Shellhooks using the foreman-installer

    # foreman-installer --enable-foreman-plugin-webhooks --enable-foreman-proxy-plugin-shellhooks

### Configure a Webhook to trigger the Shellhook print_args

Navigate to "Administer > Webhook > Webhooks" and press the "Create New" button.
In the form select "Build entered" to subscribed to, name the Webhook, add the target URL "https://foreman.localdomain:9090/shellhook/print_args",
select the template "Empty Payload", keep the HTTP method "POST" and it enabled on the tab "General". On the tab "Credentials" keep everything
except checking the Proxy Authorization. On the tab "Additional" add the headers:

```
{
  "X-Shellhook-Arg-1": "Hello",
  "X-Shellhook-Arg-2": "World"
}
```

Save it by pressing "Submit".

### Increase the log level of Smart Proxy to DEBUG

    # vi /etc/foreman-proxy/settings.yml
    ...
    :log_level: DEBUG
    ...
    # systemctl restart foreman-proxy.service

### Activate build mode of a Host and inspect the Smart Proxy's log

Navigate to "Hosts > All Hosts" and select one host. On the detail view select "Build" from the action menu "&#8942;".
